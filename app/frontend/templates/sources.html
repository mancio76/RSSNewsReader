{% extends "base.html" %}

{% block page_subtitle %}
Gestisci le fonti RSS e web scraping
{% endblock %}

{% block content %}
<!-- Header con azioni -->
<div class="flex items-center justify-between mb-6">
    <div>
        <h2 class="text-2xl font-bold text-gray-900">Sources</h2>
        <p class="text-gray-600 mt-1">{{ sources|length }} sources configurate</p>
    </div>
    <div class="sources-header-actions flex items-center space-x-2">
        <!-- I bottoni export/import verranno aggiunti qui da JavaScript -->
        <button onclick="showAddSourceModal()" class="btn-primary">
            <i class="fas fa-plus mr-2"></i>
            Aggiungi Source
        </button>
    </div>
</div>

<!-- Grid delle sources -->
<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
    <!-- Loop through sources -->
    {% for source in sources %}
    <div class="card hover:shadow-lg transition-shadow" 
        data-source-id="{{ source.id }}" 
        data-source-config="{{ source | tojsonfilter | safe }}">
        <!-- Header source -->
        <div class="p-6 border-b border-gray-200">
            <div class="flex items-start justify-between">
                <div class="flex items-center space-x-3">
                    <div class="w-10 h-10 bg-{% if source.is_active %}green{% else %}gray{% endif %}-100 rounded-lg flex items-center justify-center">
                        <i class="fas fa-{% if source.rss_url %}rss{% else %}globe{% endif %} text-{% if source.is_active %}green{% else %}gray{% endif %}-600"></i>
                    </div>
                    <div>
                        <h3 class="font-semibold text-gray-900">{{ source.name }}</h3>
                        <p class="text-sm text-gray-600">
                            {% if source.rss_url %}RSS Feed{% else %}Web Scraping{% endif %}
                        </p>
                    </div>
                </div>
                
                <!-- Status toggle -->
                <label class="relative inline-flex items-center cursor-pointer">
                    <input type="checkbox" class="sr-only peer" 
                           {% if source.is_active %}checked{% endif %}
                           onchange="toggleSource({{ source.id }}, this)">
                    <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                </label>
            </div>
        </div>
        
        <!-- Contenuto source -->
        <div class="p-6">
            <!-- URL -->
            <div class="mb-4">
                <p class="text-sm text-gray-600 mb-1">URL:</p>
                <a href="{{ source.base_url }}" target="_blank" 
                   class="text-blue-600 hover:text-blue-700 text-sm break-all">
                    {{ source.base_url[:50] }}{% if source.base_url|length > 50 %}...{% endif %}
                </a>
            </div>
            
            <!-- Statistiche -->
            <div class="grid grid-cols-2 gap-4 mb-4">
                <div class="text-center p-3 bg-gray-50 rounded-lg">
                    <div class="text-lg font-bold text-gray-900 article-count">{{ source.article_count or 0 }}</div>
                    <div class="text-xs text-gray-600">Articoli totali</div>
                </div>
                <div class="text-center p-3 bg-gray-50 rounded-lg">
                    <div class="text-lg font-bold text-{% if source.recent_articles > 0 %}green{% else %}gray{% endif %}-600 recent-count">
                        {{ source.recent_articles or 0 }}
                    </div>
                    <div class="text-xs text-gray-600">Ultimi 7 giorni</div>
                </div>
            </div>
            
            <!-- Metadati -->
            <div class="space-y-2 text-sm text-gray-600 mb-4">
                <div class="flex items-center justify-between">
                    <span>Frequenza:</span>
                    <span>{{ (source.update_frequency / 3600)|round(1) }}h</span>
                </div>
                <div class="flex items-center justify-between">
                    <span>Rate limit:</span>
                    <span>{{ source.rate_limit_delay }}s</span>
                </div>
                {% if source.last_scraped %}
                <div class="flex items-center justify-between">
                    <span>Ultimo scraping:</span>
                    <span>{{ source.last_scraped }}</span>
                </div>
                {% endif %}
            </div>
            
            <!-- Errori -->
            {% if source.error_count > 0 %}
            <div class="mb-4 p-3 bg-red-50 border border-red-200 rounded-lg">
                <div class="flex items-center">
                    <i class="fas fa-exclamation-triangle text-red-500 mr-2"></i>
                    <span class="text-red-700 text-sm font-medium">{{ source.error_count }} errori</span>
                </div>
                {% if source.last_error %}
                <p class="text-red-600 text-xs mt-1">{{ source.last_error[:100] }}...</p>
                {% endif %}
            </div>
            {% endif %}
        </div>
        
        <!-- Actions -->
        <div class="px-6 pb-6">
            <div class="flex space-x-2 actions-div">
                <button onclick="scrapeSource({{ source.id }})" 
                        class="flex-1 bg-blue-100 hover:bg-blue-200 text-blue-700 font-medium py-2 px-3 rounded-lg transition-colors text-sm">
                    <i class="fas fa-sync-alt mr-1"></i>
                    Scrape
                </button>
                <button onclick="editSource({{ source.id }})" 
                        class="flex-1 bg-gray-100 hover:bg-gray-200 text-gray-700 font-medium py-2 px-3 rounded-lg transition-colors text-sm">
                    <i class="fas fa-edit mr-1"></i>
                    Modifica
                </button>
                <button onclick="deleteSource({{ source.id }}, '{{ source.name }}')" 
                        class="bg-red-100 hover:bg-red-200 text-red-700 font-medium py-2 px-3 rounded-lg transition-colors text-sm">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        </div>
    </div>
    {% endfor %}
    
    {% if not sources %}
    <!-- Empty state -->
    <div class="col-span-full">
        <div class="text-center py-12">
            <i class="fas fa-rss text-gray-300 text-6xl mb-4"></i>
            <h3 class="text-lg font-medium text-gray-900 mb-2">Nessuna source configurata</h3>
            <p class="text-gray-500 mb-6">Inizia aggiungendo la tua prima fonte RSS o web scraping</p>
            <button onclick="showAddSourceModal()" class="btn-primary">
                <i class="fas fa-plus mr-2"></i>
                Aggiungi Prima Source
            </button>
        </div>
    </div>
    {% endif %}
</div>

<!-- Modal per aggiungere source -->
<div id="addSourceModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center">
    <div class="bg-white rounded-lg max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
        <div class="p-6 border-b border-gray-200">
            <div class="flex items-center justify-between">
                <h3 class="text-lg font-semibold text-gray-900">Aggiungi Nuova Source</h3>
                <button onclick="hideAddSourceModal()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>
        
        <form id="addSourceForm" class="p-6">
            <div class="space-y-4">
                <!-- Nome -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Nome Source *</label>
                    <input type="text" name="name" required 
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
                           placeholder="Es. BBC News, TechCrunch...">
                </div>
                
                <!-- URL Base -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">URL Base *</label>
                    <input type="url" name="base_url" required 
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
                           placeholder="https://example.com">
                </div>
                
                <!-- RSS URL -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">RSS URL (opzionale)</label>
                    <input type="url" name="rss_url" 
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
                           placeholder="https://example.com/rss">
                    <p class="text-xs text-gray-500 mt-1">Se fornito, verr√† usato il feed RSS invece del web scraping</p>
                </div>
                
                <!-- Descrizione -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Descrizione</label>
                    <textarea name="description" rows="2" 
                              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
                              placeholder="Breve descrizione della source..."></textarea>
                </div>
                
                <!-- Configurazione Scraping -->
                <div id="scrapingConfigSection">
                    <div class="flex items-center justify-between mb-3">
                        <label class="block text-sm font-medium text-gray-700">Configurazione Scraping</label>
                        <button type="button" onclick="showScrapingConfigModal()" 
                                class="text-blue-600 hover:text-blue-700 text-sm font-medium">
                            <i class="fas fa-cog mr-1"></i>
                            Configura
                        </button>
                    </div>
                    <div id="scrapingConfigPreview" class="p-3 bg-gray-50 rounded-lg border-2 border-dashed border-gray-300 text-center text-gray-500 text-sm">
                        Nessuna configurazione di scraping
                    </div>
                    <input type="hidden" name="scraping_config" id="scrapingConfigData" value="">
                </div>
                
                <!-- Configurazioni avanzate -->
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Frequenza Update (ore)</label>
                        <select name="update_frequency" 
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                            <option value="3600">1 ora</option>
                            <option value="7200">2 ore</option>
                            <option value="21600">6 ore</option>
                            <option value="43200">12 ore</option>
                            <option value="86400">24 ore</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Rate Limit (secondi)</label>
                        <select name="rate_limit_delay" 
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                            <option value="1">1 secondo</option>
                            <option value="2" selected>2 secondi</option>
                            <option value="5">5 secondi</option>
                            <option value="10">10 secondi</option>
                        </select>
                    </div>
                </div>
                
                <!-- Attiva subito -->
                <div class="flex items-center">
                    <input type="hidden" name="is_active" value="false">
                    <input type="checkbox" id="is_active" name="is_active" checked 
                           class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                    <label for="is_active" class="ml-2 block text-sm text-gray-700">
                        Attiva source immediatamente
                    </label>
                </div>
            </div>
            
            <div class="flex justify-end space-x-3 mt-6 pt-6 border-t border-gray-200">
                <button type="button" onclick="hideAddSourceModal()" 
                        class="bg-gray-100 hover:bg-gray-200 text-gray-700 font-medium py-2 px-4 rounded-lg transition-colors">
                    Annulla
                </button>
                <button type="submit" class="btn-primary">
                    <i class="fas fa-plus mr-2"></i>
                    Aggiungi Source
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Modal per Scraping Configuration -->
<div id="scrapingConfigModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center">
    <div class="bg-white rounded-lg max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto">
        <div class="p-6 border-b border-gray-200">
            <div class="flex items-center justify-between">
                <h3 class="text-lg font-semibold text-gray-900">Configurazione Web Scraping</h3>
                <button onclick="hideScrapingConfigModal()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <p class="text-sm text-gray-600 mt-2">Configura i selettori CSS per estrarre contenuti da pagine web</p>
        </div>
        
        <div class="p-6">
            <form id="scrapingConfigForm">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Selettori Base -->
                    <div class="space-y-4">
                        <h4 class="font-semibold text-gray-900 mb-3">Selettori Base</h4>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Lista Articoli
                                <span class="text-red-500">*</span>
                            </label>
                            <input type="text" name="article_list_selector" 
                                   placeholder="article, .post, .news-item"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 text-sm">
                            <p class="text-xs text-gray-500 mt-1">Selettore per trovare gli elementi articolo</p>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Titolo</label>
                            <input type="text" name="title_selector" 
                                   placeholder="h1, h2, .title, .headline"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 text-sm">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Contenuto</label>
                            <input type="text" name="content_selector" 
                                   placeholder="p, .content, .article-body"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 text-sm">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">URL Link</label>
                            <input type="text" name="url_selector" 
                                   placeholder="a, .link, .read-more"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 text-sm">
                        </div>
                    </div>
                    
                    <!-- Selettori Avanzati -->
                    <div class="space-y-4">
                        <h4 class="font-semibold text-gray-900 mb-3">Selettori Avanzati</h4>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Data Pubblicazione</label>
                            <input type="text" name="date_selector" 
                                   placeholder="time, .date, .published"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 text-sm">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Autore</label>
                            <input type="text" name="author_selector" 
                                   placeholder=".author, .byline, .writer"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 text-sm">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Sommario</label>
                            <input type="text" name="summary_selector" 
                                   placeholder=".summary, .excerpt, .description"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 text-sm">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Numero Max Articoli</label>
                            <select name="max_articles" 
                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 text-sm">
                                <option value="10">10 articoli</option>
                                <option value="20" selected>20 articoli</option>
                                <option value="50">50 articoli</option>
                                <option value="100">100 articoli</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <!-- Paginazione -->
                <div class="mt-8 p-4 bg-gray-50 rounded-lg">
                    <h4 class="font-semibold text-gray-900 mb-4">Configurazione Paginazione</h4>
                    
                    <div class="flex items-center mb-4">
                        <input type="checkbox" id="follow_pagination" name="follow_pagination" 
                               class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                        <label for="follow_pagination" class="ml-2 block text-sm text-gray-700">
                            Segui paginazione automaticamente
                        </label>
                    </div>
                    
                    <div id="paginationConfig" class="space-y-4 hidden">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Selettore Paginazione</label>
                                <input type="text" name="pagination_selector" 
                                       placeholder=".pagination a, .next, .more"
                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 text-sm">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Pagine Massime</label>
                                <select name="max_pages" 
                                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 text-sm">
                                    <option value="2">2 pagine</option>
                                    <option value="3" selected>3 pagine</option>
                                    <option value="5">5 pagine</option>
                                    <option value="10">10 pagine</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Esempi e Tips -->
                <div class="mt-6 p-4 bg-blue-50 rounded-lg">
                    <h4 class="font-semibold text-blue-900 mb-2">üí° Tips & Esempi</h4>
                    <div class="text-sm text-blue-800 space-y-1">
                        <p><strong>Selettori multipli:</strong> Usa virgole: <code>h1, h2, .title</code></p>
                        <p><strong>Classi CSS:</strong> <code>.article-title, .post-title</code></p>
                        <p><strong>ID:</strong> <code>#main-content, #article-body</code></p>
                        <p><strong>Attributi:</strong> <code>[data-article], [role="article"]</code></p>
                        <p><strong>Combinazioni:</strong> <code>article .title, .post h2</code></p>
                    </div>
                </div>
            </form>
        </div>
        
        <div class="px-6 pb-6">
            <div class="flex justify-between">
                <button type="button" onclick="testScrapingConfig()" 
                        class="bg-yellow-100 hover:bg-yellow-200 text-yellow-700 font-medium py-2 px-4 rounded-lg transition-colors">
                    <i class="fas fa-vial mr-2"></i>
                    Test Configurazione
                </button>
                
                <div class="flex space-x-3">
                    <button type="button" onclick="hideScrapingConfigModal()" 
                            class="bg-gray-100 hover:bg-gray-200 text-gray-700 font-medium py-2 px-4 rounded-lg transition-colors">
                        Annulla
                    </button>
                    <button type="button" onclick="saveScrapingConfig()" class="btn-primary">
                        <i class="fas fa-save mr-2"></i>
                        Salva Configurazione
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal per Edit Source -->
<div id="editSourceModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center">
    <div class="bg-white rounded-lg max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
        <div class="p-6 border-b border-gray-200">
            <div class="flex items-center justify-between">
                <h3 class="text-lg font-semibold text-gray-900">Modifica Source</h3>
                <button onclick="hideEditSourceModal()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>
        
        <form id="editSourceForm" class="p-6">
            <input type="hidden" name="source_id" id="editSourceId">
            
            <div class="space-y-4">
                <!-- Nome -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Nome Source *</label>
                    <input type="text" name="name" id="editSourceName" required 
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                </div>
                
                <!-- URL Base -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">URL Base *</label>
                    <input type="url" name="base_url" id="editSourceBaseUrl" required 
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                </div>
                
                <!-- RSS URL -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">RSS URL (opzionale)</label>
                    <input type="url" name="rss_url" id="editSourceRssUrl" 
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                </div>
                
                <!-- Descrizione -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Descrizione</label>
                    <textarea name="description" id="editSourceDescription" rows="2" 
                              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"></textarea>
                </div>
                
                <!-- Configurazione Scraping Edit -->
                <div id="editScrapingConfigSection">
                    <div class="flex items-center justify-between mb-3">
                        <label class="block text-sm font-medium text-gray-700">Configurazione Scraping</label>
                        <button type="button" onclick="editScrapingConfig()" 
                                class="text-blue-600 hover:text-blue-700 text-sm font-medium">
                            <i class="fas fa-cog mr-1"></i>
                            Modifica
                        </button>
                    </div>
                    <div id="editScrapingConfigPreview" class="p-3 bg-gray-50 rounded-lg border border-gray-300 text-sm">
                        <div class="text-gray-500">Nessuna configurazione</div>
                    </div>
                    <input type="hidden" name="scraping_config" id="editScrapingConfigData" value="">
                </div>
                
                <!-- Configurazioni avanzate -->
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Frequenza Update (ore)</label>
                        <select name="update_frequency" id="editSourceUpdateFreq" 
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                            <option value="3600">1 ora</option>
                            <option value="7200">2 ore</option>
                            <option value="21600">6 ore</option>
                            <option value="43200">12 ore</option>
                            <option value="86400">24 ore</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Rate Limit (secondi)</label>
                        <select name="rate_limit_delay" id="editSourceRateLimit" 
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                            <option value="1">1 secondo</option>
                            <option value="2">2 secondi</option>
                            <option value="5">5 secondi</option>
                            <option value="10">10 secondi</option>
                        </select>
                    </div>
                </div>
                
                <!-- Stato attivo -->
                <div class="flex items-center">
                    <input type="hidden" name="is_active" value="false">
                    <input type="checkbox" id="editSourceActive" name="is_active" 
                           class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                    <label for="editSourceActive" class="ml-2 block text-sm text-gray-700">
                        Source attiva
                    </label>
                </div>
            </div>
            
            <div class="flex justify-end space-x-3 mt-6 pt-6 border-t border-gray-200">
                <button type="button" onclick="hideEditSourceModal()" 
                        class="bg-gray-100 hover:bg-gray-200 text-gray-700 font-medium py-2 px-4 rounded-lg transition-colors">
                    Annulla
                </button>
                <button type="submit" class="btn-primary">
                    <i class="fas fa-save mr-2"></i>
                    Salva Modifiche
                </button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Global variables
let currentScrapingConfig = {};
let currentEditingSourceId = null;

function setupCheckboxHandling() {
    // Per il form di aggiunta
    const addForm = document.getElementById('addSourceForm');
    addForm.addEventListener('submit', function(e) {
        const checkbox = this.querySelector('input[name="is_active"][type="checkbox"]');
        const hidden = this.querySelector('input[name="is_active"][type="hidden"]');
        
        if (checkbox.checked) {
            hidden.disabled = true; // Disabilita hidden se checkbox √® checked
        } else {
            hidden.disabled = false; // Abilita hidden se checkbox non √® checked
        }
    });
    
    // Per il form di modifica
    const editForm = document.getElementById('editSourceForm');
    editForm.addEventListener('submit', function(e) {
        const checkbox = this.querySelector('input[name="is_active"][type="checkbox"]');
        const hidden = this.querySelector('input[name="is_active"][type="hidden"]');
        
        if (checkbox.checked) {
            hidden.disabled = true; // Disabilita hidden se checkbox √® checked
        } else {
            hidden.disabled = false; // Abilita hidden se checkbox non √® checked
        }
    });
}

// Toggle source status
async function toggleSource(sourceId, checkbox) {
    try {
        const response = await fetch(`/web/sources/toggle/${sourceId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        if (response.ok) {
            const result = await response.json();
            showToast(`Source ${result.is_active ? 'attivata' : 'disattivata'}`, 'success');
        } else {
            // Revert checkbox state on error
            checkbox.checked = !checkbox.checked;
            showToast('Errore nel cambiare stato della source', 'error');
        }
    } catch (error) {
        checkbox.checked = !checkbox.checked;
        showToast('Errore di connessione', 'error');
    }
}

// Scrape single source
async function scrapeSource(sourceId) {
    try {
        showToast('Avvio scraping...', 'info');
        
        const response = await fetch(`/sources/${sourceId}/scrape`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        if (response.ok) {
            const result = await response.json();
            const articlesCount = result.results[0]?.articles_scraped || 0;
            showToast(`Scraping completato: ${articlesCount} articoli trovati`, 'success');
            
            // Refresh page after delay
            setTimeout(() => location.reload(), 2000);
        } else {
            const error = await response.json();
            showToast(`Errore: ${error.detail}`, 'error');
        }
    } catch (error) {
        showToast('Errore di connessione', 'error');
    }
}

// Delete source
async function deleteSource(sourceId, sourceName) {
    if (!confirm(`Sei sicuro di voler eliminare la source "${sourceName}"?\n\nTutti gli articoli associati verranno eliminati.`)) {
        return;
    }
    
    try {
        const response = await fetch(`/sources/${sourceId}`, {
            method: 'DELETE'
        });
        
        if (response.ok) {
            showToast('Source eliminata con successo', 'success');
            location.reload();
        } else {
            const error = await response.json();
            showToast(`Errore: ${error.detail}`, 'error');
        }
    } catch (error) {
        showToast('Errore di connessione', 'error');
    }
}

// Edit source
async function editSource(sourceId) {
    try {
        currentEditingSourceId = sourceId;
        
        // Fetch source data
        const response = await fetch(`/sources/${sourceId}`);
        if (!response.ok) {
            showToast('Errore nel caricare i dati della source', 'error');
            return;
        }
        
        const source = await response.json();
        
        // Populate form
        document.getElementById('editSourceId').value = source.id;
        document.getElementById('editSourceName').value = source.name;
        document.getElementById('editSourceBaseUrl').value = source.base_url;
        document.getElementById('editSourceRssUrl').value = source.rss_url || '';
        document.getElementById('editSourceDescription').value = source.description || '';
        document.getElementById('editSourceUpdateFreq').value = source.update_frequency;
        document.getElementById('editSourceRateLimit').value = source.rate_limit_delay;
        document.getElementById('editSourceActive').checked = source.is_active;
        
        // Handle scraping config
        if (source.scraping_config) {
            currentScrapingConfig = source.scraping_config;
            updateScrapingConfigPreview('edit');
        } else {
            currentScrapingConfig = {};
            document.getElementById('editScrapingConfigPreview').innerHTML = 
                '<div class="text-gray-500">Nessuna configurazione</div>';
        }
        
        showEditSourceModal();
        
    } catch (error) {
        showToast('Errore di connessione', 'error');
    }
}

// Modal functions for Add Source
function showAddSourceModal() {
    document.getElementById('addSourceModal').classList.remove('hidden');
    document.body.style.overflow = 'hidden';
}

function hideAddSourceModal() {
    document.getElementById('addSourceModal').classList.add('hidden');
    document.body.style.overflow = 'auto';
    document.getElementById('addSourceForm').reset();
    currentScrapingConfig = {};
    updateScrapingConfigPreview('add');
}

// Modal functions for Edit Source
function showEditSourceModal() {
    document.getElementById('editSourceModal').classList.remove('hidden');
    document.body.style.overflow = 'hidden';
}

function hideEditSourceModal() {
    document.getElementById('editSourceModal').classList.add('hidden');
    document.body.style.overflow = 'auto';
    currentEditingSourceId = null;
    currentScrapingConfig = {};
}

// Modal functions for Scraping Config
function showScrapingConfigModal() {
    document.getElementById('scrapingConfigModal').classList.remove('hidden');
    document.body.style.overflow = 'hidden';
    
    // Populate form with current config
    populateScrapingConfigForm();
}

function hideScrapingConfigModal() {
    document.getElementById('scrapingConfigModal').classList.add('hidden');
    document.body.style.overflow = 'auto';
}

function editScrapingConfig() {
    showScrapingConfigModal();
}

// Populate scraping config form
function populateScrapingConfigForm() {
    const form = document.getElementById('scrapingConfigForm');
    const config = currentScrapingConfig || {};
    
    // Base selectors
    form.querySelector('[name="article_list_selector"]').value = config.article_list_selector || '';
    form.querySelector('[name="title_selector"]').value = config.title_selector || '';
    form.querySelector('[name="content_selector"]').value = config.content_selector || '';
    form.querySelector('[name="url_selector"]').value = config.url_selector || '';
    form.querySelector('[name="date_selector"]').value = config.date_selector || '';
    form.querySelector('[name="author_selector"]').value = config.author_selector || '';
    form.querySelector('[name="summary_selector"]').value = config.summary_selector || '';
    form.querySelector('[name="max_articles"]').value = config.max_articles || 20;
    
    // Pagination
    const followPagination = form.querySelector('[name="follow_pagination"]');
    followPagination.checked = config.follow_pagination || false;
    form.querySelector('[name="pagination_selector"]').value = config.pagination_selector || '';
    form.querySelector('[name="max_pages"]').value = config.max_pages || 3;
    
    // Show/hide pagination config
    togglePaginationConfig();
}

// Toggle pagination configuration
function togglePaginationConfig() {
    const checkbox = document.querySelector('#follow_pagination');
    const config = document.querySelector('#paginationConfig');
    
    if (checkbox.checked) {
        config.classList.remove('hidden');
    } else {
        config.classList.add('hidden');
    }
}

// Save scraping configuration
function saveScrapingConfig() {
    const form = document.getElementById('scrapingConfigForm');
    const formData = new FormData(form);
    
    const config = {};
    
    // Required field check
    const articleListSelector = formData.get('article_list_selector');
    if (!articleListSelector.trim()) {
        showToast('Il selettore "Lista Articoli" √® obbligatorio', 'error');
        return;
    }
    
    // Build config object
    if (articleListSelector) config.article_list_selector = articleListSelector;
    if (formData.get('title_selector')) config.title_selector = formData.get('title_selector');
    if (formData.get('content_selector')) config.content_selector = formData.get('content_selector');
    if (formData.get('url_selector')) config.url_selector = formData.get('url_selector');
    if (formData.get('date_selector')) config.date_selector = formData.get('date_selector');
    if (formData.get('author_selector')) config.author_selector = formData.get('author_selector');
    if (formData.get('summary_selector')) config.summary_selector = formData.get('summary_selector');
    
    config.max_articles = parseInt(formData.get('max_articles')) || 20;
    
    // Pagination
    if (formData.get('follow_pagination') === 'on') {
        config.follow_pagination = true;
        if (formData.get('pagination_selector')) {
            config.pagination_selector = formData.get('pagination_selector');
        }
        config.max_pages = parseInt(formData.get('max_pages')) || 3;
    }
    
    currentScrapingConfig = config;
    updateScrapingConfigPreview();
    hideScrapingConfigModal();
    showToast('Configurazione scraping salvata', 'success');
}

// Update scraping config preview
function updateScrapingConfigPreview(mode = 'add') {
    const previewId = mode === 'edit' ? 'editScrapingConfigPreview' : 'scrapingConfigPreview';
    const dataId = mode === 'edit' ? 'editScrapingConfigData' : 'scrapingConfigData';
    const preview = document.getElementById(previewId);
    const dataInput = document.getElementById(dataId);
    
    if (Object.keys(currentScrapingConfig).length === 0) {
        preview.innerHTML = '<div class="text-gray-500 text-center">Nessuna configurazione di scraping</div>';
        preview.className = "p-3 bg-gray-50 rounded-lg border-2 border-dashed border-gray-300 text-center text-gray-500 text-sm";
        dataInput.value = '';
        return;
    }
    
    let html = '<div class="space-y-2">';
    
    if (currentScrapingConfig.article_list_selector) {
        html += `<div class="flex justify-between">
            <span class="font-medium">Lista:</span>
            <code class="text-xs bg-gray-200 px-1 rounded">${currentScrapingConfig.article_list_selector}</code>
        </div>`;
    }
    
    if (currentScrapingConfig.title_selector) {
        html += `<div class="flex justify-between">
            <span class="font-medium">Titolo:</span>
            <code class="text-xs bg-gray-200 px-1 rounded">${currentScrapingConfig.title_selector}</code>
        </div>`;
    }
    
    if (currentScrapingConfig.content_selector) {
        html += `<div class="flex justify-between">
            <span class="font-medium">Contenuto:</span>
            <code class="text-xs bg-gray-200 px-1 rounded">${currentScrapingConfig.content_selector}</code>
        </div>`;
    }
    
    html += `<div class="flex justify-between">
        <span class="font-medium">Max Articoli:</span>
        <span class="text-xs">${currentScrapingConfig.max_articles || 20}</span>
    </div>`;
    
    if (currentScrapingConfig.follow_pagination) {
        html += `<div class="text-xs text-blue-600 font-medium">
            <i class="fas fa-list mr-1"></i>
            Paginazione attiva (${currentScrapingConfig.max_pages || 3} pagine)
        </div>`;
    }
    
    html += '</div>';
    
    preview.innerHTML = html;
    preview.className = "p-3 bg-blue-50 rounded-lg border border-blue-200 text-sm";
    dataInput.value = JSON.stringify(currentScrapingConfig);
}

// Test scraping configuration
async function testScrapingConfig() {
    const form = document.getElementById('scrapingConfigForm');
    const formData = new FormData(form);
    const baseUrl = document.querySelector('[name="base_url"]')?.value;
    
    if (!baseUrl) {
        showToast('Inserisci prima l\'URL base della source', 'error');
        return;
    }
}

// Toggle source status
async function toggleSource(sourceId, checkbox) {
    try {
        const response = await fetch(`/web/sources/toggle/${sourceId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        if (response.ok) {
            const result = await response.json();
            showToast(`Source ${result.is_active ? 'attivata' : 'disattivata'}`, 'success');
        } else {
            // Revert checkbox state on error
            checkbox.checked = !checkbox.checked;
            showToast('Errore nel cambiare stato della source', 'error');
        }
    } catch (error) {
        checkbox.checked = !checkbox.checked;
        showToast('Errore di connessione', 'error');
    }
}

// Scrape single source
async function scrapeSource(sourceId) {
    try {
        showToast('Avvio scraping...', 'info');
        
        const response = await fetch(`/sources/${sourceId}/scrape`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        if (response.ok) {
            const result = await response.json();
            const articlesCount = result.results[0]?.articles_scraped || 0;
            showToast(`Scraping completato: ${articlesCount} articoli trovati`, 'success');
            
            // Refresh page after delay
            setTimeout(() => location.reload(), 2000);
        } else {
            const error = await response.json();
            showToast(`Errore: ${error.detail}`, 'error');
        }
    } catch (error) {
        showToast('Errore di connessione', 'error');
    }
}

// Delete source
async function deleteSource(sourceId, sourceName) {
    if (!confirm(`Sei sicuro di voler eliminare la source "${sourceName}"?\n\nTutti gli articoli associati verranno eliminati.`)) {
        return;
    }
    
    try {
        const response = await fetch(`/sources/${sourceId}`, {
            method: 'DELETE'
        });
        
        if (response.ok) {
            showToast('Source eliminata con successo', 'success');
            location.reload();
        } else {
            const error = await response.json();
            showToast(`Errore: ${error.detail}`, 'error');
        }
    } catch (error) {
        showToast('Errore di connessione', 'error');
    }
}

// Edit source (placeholder)
// function editSource(sourceId) {
//     showEditSourceModal();
//     //showToast('Funzionalit√† di modifica in sviluppo', 'info');
// }

// Modal functions
function showAddSourceModal() {
    document.getElementById('addSourceModal').classList.remove('hidden');
    document.body.style.overflow = 'hidden';
}

function hideAddSourceModal() {
    document.getElementById('addSourceModal').classList.add('hidden');
    document.body.style.overflow = 'auto';
    document.getElementById('addSourceForm').reset();
}

// 5. AGGIUNTA: Funzione per validare source
function addValidateButton() {
    // Aggiungi bottone validate accanto a scrape in ogni source card
    const sourceCards = document.querySelectorAll('.source-card');
    sourceCards.forEach(card => {
        const sourceId = card.dataset.sourceId;
        const actionsDiv = card.querySelector('.actions-div');
        
        const validateBtn = document.createElement('button');
        validateBtn.onclick = () => validateSource(sourceId);
        validateBtn.className = 'bg-yellow-100 hover:bg-yellow-200 text-yellow-700 font-medium py-2 px-3 rounded-lg transition-colors text-sm';
        validateBtn.innerHTML = '<i class="fas fa-check-circle mr-1"></i>Valida';
        
        actionsDiv.insertBefore(validateBtn, actionsDiv.lastElementChild);
    });
}

// 6. MIGLIORAMENTO: Funzione per refresh parziale delle source senza ricaricare pagina
async function refreshSourceStats() {
    try {
        const response = await fetch('/sources/stats/summary');
        if (response.ok) {
            const stats = await response.json();
            
            // Aggiorna contatori nella pagina
            document.querySelectorAll('.source-card').forEach(card => {
                const sourceId = parseInt(card.dataset.sourceId);
                const sourceStats = stats.sources?.find(s => s.id === sourceId);
                
                if (sourceStats) {
                    // Aggiorna contatori articoli
                    const articleCountElement = card.querySelector('.article-count');
                    if (articleCountElement) {
                        articleCountElement.textContent = sourceStats.article_count || 0;
                    }
                    
                    const recentCountElement = card.querySelector('.recent-count');
                    if (recentCountElement) {
                        recentCountElement.textContent = sourceStats.recent_articles || 0;
                    }
                }
            });
        }
    } catch (error) {
        console.warn('Failed to refresh source stats:', error);
    }
}

// 7. AGGIUNTA: Gestione errori pi√π robusta per le operazioni CRUD
function showDetailedError(error, operation) {
    let message = `Errore durante ${operation}`;
    
    if (error.response) {
        // Errore HTTP con risposta del server
        message += `: ${error.response.status} - ${error.response.statusText}`;
    } else if (error.message) {
        // Errore JavaScript
        message += `: ${error.message}`;
    }
    
    showToast(message, 'error');
    console.error(`${operation} failed:`, error);
}

// 8. AGGIUNTA: Funzione per esportare configurazione sources
async function exportSourcesConfig() {
    try {
        showToast('Preparazione export configurazione...', 'info');
        
        const sources = [];
        document.querySelectorAll('.source-card').forEach(card => {
            const sourceData = JSON.parse(card.dataset.sourceConfig || '{}');
            sources.push(sourceData);
        });
        
        const exportData = {
            export_date: new Date().toISOString(),
            sources: sources
        };
        
        const blob = new Blob([JSON.stringify(exportData, null, 2)], { 
            type: 'application/json' 
        });
        const url = URL.createObjectURL(blob);
        
        const a = document.createElement('a');
        a.href = url;
        a.download = `sources_config_${new Date().toISOString().split('T')[0]}.json`;
        a.click();
        
        URL.revokeObjectURL(url);
        showToast('Export completato!', 'success');
        
    } catch (error) {
        showDetailedError(error, 'export configurazione');
    }
}

// 9. AGGIUNTA: Funzione per importare configurazione sources
function importSourcesConfig() {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = '.json';
    
    input.onchange = async function(e) {
        const file = e.target.files[0];
        if (!file) return;
        
        try {
            const text = await file.text();
            const config = JSON.parse(text);
            
            if (!config.sources || !Array.isArray(config.sources)) {
                showToast('File di configurazione non valido', 'error');
                return;
            }
            
            const confirmMsg = `Importare ${config.sources.length} sources?\n\nQuesto potrebbe sovrascrivere sources esistenti con lo stesso nome.`;
            
            if (confirm(confirmMsg)) {
                await bulkImportSources(config.sources);
            }
            
        } catch (error) {
            showDetailedError(error, 'import configurazione');
        }
    };
    
    input.click();
}

async function bulkImportSources(sources) {
    let imported = 0;
    let errors = 0;
    
    showToast(`Importazione di ${sources.length} sources...`, 'info');
    
    for (const sourceConfig of sources) {
        try {
            const formData = new FormData();
            formData.append('name', sourceConfig.name);
            formData.append('base_url', sourceConfig.base_url);
            if (sourceConfig.rss_url) formData.append('rss_url', sourceConfig.rss_url);
            if (sourceConfig.description) formData.append('description', sourceConfig.description);
            formData.append('is_active', sourceConfig.is_active || false);
            formData.append('update_frequency', sourceConfig.update_frequency || 3600);
            formData.append('rate_limit_delay', sourceConfig.rate_limit_delay || 2);
            if (sourceConfig.scraping_config) {
                formData.append('scraping_config', JSON.stringify(sourceConfig.scraping_config));
            }
            
            const response = await fetch('/web/sources/add', {
                method: 'POST',
                body: formData
            });
            
            if (response.ok) {
                imported++;
            } else {
                errors++;
                console.warn(`Failed to import source: ${sourceConfig.name}`);
            }
            
        } catch (error) {
            errors++;
            console.error(`Error importing source ${sourceConfig.name}:`, error);
        }
        
        // Piccola pausa per non sovraccaricare il server
        await new Promise(resolve => setTimeout(resolve, 100));
    }
    
    showToast(`Import completato: ${imported} sources importate, ${errors} errori`, 
              errors > 0 ? 'warning' : 'success');
    
    if (imported > 0) {
        setTimeout(() => location.reload(), 2000);
    }
}

// 10. AGGIUNTA: Bottoni export/import nella pagina
function addExportImportButtons() {
    const headerActions = document.querySelector('.sources-header-actions');
    if (headerActions) {
        const exportBtn = document.createElement('button');
        exportBtn.onclick = exportSourcesConfig;
        exportBtn.className = 'bg-green-100 hover:bg-green-200 text-green-700 font-medium py-2 px-3 rounded-lg transition-colors text-sm mr-2';
        exportBtn.innerHTML = '<i class="fas fa-download mr-1"></i>Export';
        
        const importBtn = document.createElement('button');
        importBtn.onclick = importSourcesConfig;
        importBtn.className = 'bg-purple-100 hover:bg-purple-200 text-purple-700 font-medium py-2 px-3 rounded-lg transition-colors text-sm mr-2';
        importBtn.innerHTML = '<i class="fas fa-upload mr-1"></i>Import';
        
        headerActions.insertBefore(exportBtn, headerActions.firstChild);
        headerActions.insertBefore(importBtn, headerActions.firstChild);
    }
}

// Add source form submission
document.getElementById('addSourceForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const data = {
        name: formData.get('name'),
        base_url: formData.get('base_url'),
        rss_url: formData.get('rss_url') || null,
        description: formData.get('description') || null,
        is_active: formData.get('is_active') === 'on',
        update_frequency: parseInt(formData.get('update_frequency')),
        rate_limit_delay: parseInt(formData.get('rate_limit_delay'))
    };
    
    try {
        showToast('Creazione source in corso...', 'info');
        
        const response = await fetch('/sources/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        });
        
        if (response.ok) {
            const result = await response.json();
            showToast(`Source "${data.name}" creata con successo!`, 'success');
            hideAddSourceModal();
            location.reload();
        } else {
            const error = await response.json();
            showToast(`Errore: ${error.detail}`, 'error');
        }
    } catch (error) {
        showToast('Errore di connessione', 'error');
    }
});

// Edit source form submission
document.getElementById('editSourceForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    source_id: parseInt(formData.get('source_id'))
    const formData = new FormData(this);
    const data = {
        //source_id: source_id,
        name: formData.get('name'),
        base_url: formData.get('base_url'),
        rss_url: formData.get('rss_url') || null,
        description: formData.get('description') || null,
        is_active: formData.get('is_active') === 'on',
        update_frequency: parseInt(formData.get('update_frequency')),
        rate_limit_delay: parseInt(formData.get('rate_limit_delay'))
    };
    
    try {
        showToast('Modifica source in corso...', 'info');
        
        const response = await fetch(`/sources/${source_id}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        });
        
        if (response.ok) {
            const result = await response.json();
            showToast(`Source "${data.name}" modificata con successo!`, 'success');
            hideAddSourceModal();
            location.reload();
        } else {
            const error = await response.json();
            showToast(`Errore: ${error.detail}`, 'error');
        }
    } catch (error) {
        showToast('Errore di connessione', 'error');
    }
});

// Close modal on escape key
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        hideAddSourceModal();
    }
});

// Close modal on backdrop click
document.getElementById('addSourceModal').addEventListener('click', function(e) {
    if (e.target === this) {
        hideAddSourceModal();
    }
});

// Chiama la funzione al caricamento della pagina
document.addEventListener('DOMContentLoaded', setupCheckboxHandling);

// Inizializzazione completa
document.addEventListener('DOMContentLoaded', function() {
    setupCheckboxHandling();
    addExportImportButtons();
    
    // Auto-refresh stats ogni 2 minuti
    setInterval(refreshSourceStats, 120000);
});

// Auto-refresh sources every 60 seconds
setInterval(() => {
    // You could implement partial updates here
    console.log('Auto-refresh would happen here');
}, 60000);
</script>        
{% endblock %}
